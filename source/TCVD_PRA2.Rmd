---
title: 'TCVD Práctica 2: ¿Cómo realizar la limpieza y análisis de datos?'
author: 
   Alfonso Manuel Carvajal, Eider Ibiricu
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output: 
  pdf_document:
    number_sections: yes
    toc: no
    df_print: "kable"
bibliography: references.bib
nocite: |
  @manualUOC, @awesome_tables, @RMarkdownCookbook, @ggplot2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.pos = "H",
  tidy.opts = list(width.cutoff = 60),
  tidy = FALSE
  )

kable_setup <- function(df){
  df %>% kable( "latex", booktabs = T) %>%
  kable_styling(latex_options = c(
    "striped",
    "HOLD_position",
    "scale_down"))
}
```


```{r libraries, message=FALSE, include=FALSE}
if(!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
if(!require('tidyr')) install.packages('tidyr'); library('tidyr')
if(!require('dplyr')) install.packages('dplyr'); library('dplyr')
if(!require('kableExtra')) install.packages('kableExtra'); library('kableExtra')
if(!require('gridExtra')) install.packages('gridExtra'); library('gridExtra')
if(!require('formatR')) install.packages('formatR'); library('formatR')
if(!require('devtools')) install.packages('devtools'); library('devtools')
if(!require('kaggler')) devtools::install_github("ldurazo/kaggler")
```
# Descripción del dataset

El dataset *Heart Attack Analysis & Prediction* [kaggle](https://www.kaggle.com/datasets/rashikrahmanpritom/heart-attack-analysis-prediction-dataset) contiene datos para realizar una clasificación de pacientes que tengan riesgo de sufrir un ataque al corazón. 

Mediante este juego de datos es posible entrenar algoritmos que permitan un diagnóstico para futuros posibles pacientes. 


```{r download_data, message= FALSE, warning=FALSE}
#https://medium.com/mcd-unison/how-to-use-kaggle-api-to-download-datasets-in-r-312179c7a99c

library(readr)
library(kaggler)
kgl_auth(creds_file = 'kaggle.json')
response <- kgl_datasets_download_all(owner_dataset =
            "rashikrahmanpritom/heart-attack-analysis-prediction-dataset")

download.file(response[["url"]], "data/temp.zip", mode="wb")
unzip_result <- unzip("data/temp.zip", exdir = "data/", overwrite = TRUE)
unzip_result
heart_attack_data <- read_csv("data/heart.csv")
o2_saturation_data <- read.csv("data/o2Saturation.csv",header=F)

rm(response)
```
Las variables que encontramos en el dataset, según la descripción en *kaggle*:


- **Age**: Age of the patient (numeric)

- **Sex**: Sex of the patient (1 = male; 0 = female; categoric)

- **cp**: Chest Pain type chest pain type (categorical)

    - Value 1: typical angina
    
    - Value 2: atypical angina
    
    - Value 3: non-anginal pain
    
    - Value 4: asymptomatic

- **trtbps**: resting blood pressure (in mm Hg) (numerical)

- **chol**: cholestoral in mg/dl fetched via BMI sensor (numerical)

- **fbs**: (fasting blood sugar > 120 mg/dl) (1 = true; 0 = false; categorical)

- **restecg**: resting electrocardiographic results (categorical)

    - Value 0: normal
    
    - Value 1: having ST-T wave abnormality (T wave inversions and/or ST elevation or depression of > 0.05 mV)
    
    - Value 2: showing probable or definite left ventricular hypertrophy by Estes' criteria

- **thalachh**: maximum heart rate achieved

- **exng**: exercise induced angina (1 = yes; 0 = no; categoric)

- **oldpeak**: Previous peak, changes in the ST segment on an ECG

- **slp**: The Slope of The Peak Exercise ST Segment

- **caa**: number of major vessels (0-4) (integer)

- **thall**: maximum heart rate achieved (numerical)

- **output**: 0= less chance of heart attack 1= more chance of heart attack (categorical)

```{r}
# Data types

data <- heart_attack_data %>% 
  mutate(
    sex = factor(sex, levels=c(1,0),labels = c("male","female")),
    cp = factor(cp,
                levels=c(0,1,2,3),
                labels=c("typical angina","atypical angina","non-anginal pain","asymptomatic")),
    fbs = factor(fbs,levels=c(0,1),labels = c(F,T)),
    restecg = factor(restecg,levels = c(0,1,2),
                     labels = c("normal","ST-T wave abnormality","left ventricular hypertrophy")),
    exng = factor(exng),
    slp = factor(slp,levels = c(0,1,2),
                 labels = c("unsloping","flat","downsloping")),
    caa = as.integer(caa),
    output = factor(output,levels=c(0,1),
                    labels = c("less chance of heart attack","more chance of heart attack"))
  )
```
¿Por qué es importante y qué pregunta/problema
pretende responder?

# Integración y selección de los datos de interés a analizar. 

Puede ser el resultado de adicionar diferentes datasets o una subselección útil de los datos
originales, en base al objetivo que se quiera conseguir.

```{r}
head(data) %>% 
  kable_setup %>% 
  kable_paper(full_width = F)%>% 
  column_spec(c(3,7,14), width = "2 cm") %>%
  column_spec(c(1,5,9,12,13), width = "0.8 cm") %>% 
  row_spec(0,bold=TRUE)
```
# Limpieza de los datos

https://www.kaggle.com/code/tumpanjawat/heart-attack-eda-cluster-8-ml-models
```{r}
# Summary
summary(data) 

# Duplicates
data %>% 
  unique() %>% 
  nrow()

data <- data %>% 
  unique()

```
## ¿Los datos contienen ceros o elementos vacíos? Gestiona cada uno de
estos casos.
```{r}
for(col in colnames(data)){
  print(paste0("Num. of Nas in ",col,": ", length(which(is.na(data$col)))))
}
```

## Identifica y gestiona los valores extremos.
Distribución de las variables numéricas:
```{r}
# Boxplots
data_num %>% 
pivot_longer(colnames(data_num)) %>% 
  as.data.frame() %>% 
  ggplot(aes(y = value)) +    # Draw each column as histogram
  geom_boxplot(fill = "#404080") + 
  theme_minimal() +
  facet_wrap(~ name, scales = "free")


# outliers
boxplot.stats(data_num$oldpeak)$out

```
# Análisis de los datos

## Selección de los grupos de datos que se quieren analizar/comparar (p.
ej., si se van a comparar grupos de datos, ¿cuáles son estos grupos y
qué tipo de análisis se van a aplicar?)


```{r, fig.height = 10}
## Numerical data
data_num <- data %>% 
  select_if(is.numeric)
data_num %>% 
pivot_longer(colnames(data_num)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = value)) +    # Draw each column as histogram
  geom_histogram() + 
  facet_wrap(~ name, scales = "free")


## Categorical data
data_cat <- data %>% 
  select_if(~class(.) == 'factor')

# Barplots

p <- list()
cols = colnames(data_cat)
for(i in 1:length(cols)){
  col = cols[i]
  p[[i]] <- data_cat %>%
  ggplot(aes_string(col, fill = col)) + 
  geom_bar() + 
  ggtitle(paste0(col," distribution")) +
  # theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
    theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
}
do.call(grid.arrange,c(p, ncol = 2))

```
## Comprobación de la normalidad y homogeneidad de la varianza.

## Aplicación de pruebas estadísticas para comparar los grupos de datos.
En función de los datos y el objetivo del estudio, aplicar pruebas de
contraste de hipótesis, correlaciones, regresiones, etc. Aplicar al menos
tres métodos de análisis diferentes.

# Representación de los resultados a partir de tablas y gráficas.

Este apartado se puede responder a lo largo de la práctica, sin necesidad de concentrar todas
las representaciones en este punto de la práctica.

# Resolución del problema. 

A partir de los resultados obtenidos, ¿cuáles son
las conclusiones? ¿Los resultados permiten responder al problema?

# Código. 

Hay que adjuntar el código, preferiblemente en R, con el que se ha
realizado la limpieza, análisis y representación de los datos. Si lo preferís,
también podéis trabajar en Python.

# Vídeo.


